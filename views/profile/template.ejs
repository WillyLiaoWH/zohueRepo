
<% for(var i=0; i<timelinesList.length; i++) {
  timelinesList[i].contentImg // 預先處理圖片
    = timelinesList[i].contentImg
    .replace(/dummy href=/g, "a href=")
    .replace(/\/dummy/g, "\/a");%>

<div class="container-fluid timeline_event" style="margin-top:30px;">
   <!--作者訊息-->
   <div class="row-fluid event_info">
      <table style="width:100%;">
         <tbody>
            <tr>
               <td rowspan="2" style="width:50px;padding-right:15px;">
                  <img src="<%= avatar %>" height="50" width="50">
               </td>
               <td>
                  <!--作者為塗鴉牆主人-->
                  <% if(typeof timelinesList[i].owner == "undefined"){ %>
                    <div id="event_author_name" style="float:left;">
                      <a href="?<%= id %>"><%= alias %></a>
                    </div>
                  <!--作者為第三人或訪問者-->
                  <% }else{ %>
                    <div id="event_author_name" style="float:left;">
                      <a href="?<%= timelinesList[i].owner.id %>"><%= timelinesList[i].owner.alias %></a> > <a href="?<%= id %>"><%= alias %></a>
                    </div>
                  <% } %>
               </td>
            </tr>
            <tr>
               <td>
                  <div id="event_time"><%= new Date(timelinesList[i].updatedTime).toISOString().replace(/T/, ' ').replace(/\..+/, '') %></div>
               </td>
            </tr>
         </tbody>
      </table>
   </div>

   <!--編輯區塊-->
   <% if(traveler != "guest"){ %>
   <div class="container-fluid container_edit" id="container_edit<%= timelinesList[i].id %>">
      <% if(timelinesList[i].contentImg == ""){ %>
        <div class="row-fluid" id="div_edit_content<%= timelinesList[i].id %>" contenteditable="true" style=""><%= timelinesList[i].content %></div>
        <div class="row-fluid div_edit_img" id="div_edit_img<%= timelinesList[i].id %>" style="display:block;"></div>
      <% }else{ %>
        <div class="row-fluid" id="div_edit_content<%= timelinesList[i].id %>" contenteditable="true" style="border-bottom-left-radius: 0px;border-bottom-right-radius: 0px;"><%= timelinesList[i].content %></div>
        <div class="row-fluid div_edit_img" id="div_edit_img<%= timelinesList[i].id %>" style="display:block;"> <%- timelinesList[i].contentImg %> </div>
      <% } %>
      <button value="編輯完成" id="editSend" class="b" name="<%= timelinesList[i].id %>"><img src="/images/img_forum/check_icon.png">編輯完成</button>
      <button value="插入圖片" id="editImage" class="b" name="<%= timelinesList[i].id %>"><img src="/images/img_forum/images_icon.png">插入圖片</button>
      <button value="取消編輯" id="editCancel" class="b" name="<%= timelinesList[i].id %>"><span class="glyphicon glyphicon-remove" style="color:black;top:4px;" aria-hidden="true"></span>取消編輯</button>              
   </div>
   <% } %>

   <!--文章內容-->
   <div class="row-fluid event_text"><%- timelinesList[i].content.replace(/\bhttps:\/\/www\.youtube\.com\/watch\?v\=+(\w*)+\b/g, '<iframe width="560" height="315" src="https://www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe>') %></div>
   <% if(timelinesList[i].contentImg == ""){ %>
    <div class="row-fluid event_img" style="display:none;"></div>
   <% }else{ %>
    <div class="row-fluid event_img" style="display:block;"><%- timelinesList[i].contentImg %></div>
   <% } %>

   <!--推薦及設定-->
   <% if(traveler != "guest"){ %>
   <div class="row-fluid event_option btn-group">
      <div class="btn-group" id="niceArticle<%= timelinesList[i].id %>" style="float:none;">
        <% if( JSON.stringify(timelinesList[i].nicer).indexOf('{"id":'+traveler+'}') > 0){ %>
          <button value="收回" class="n" name="<%= timelinesList[i].id %>" id="TimelineCancelNice">
            <img style="width:24px; height:24px;" src="/images/img_forum/good2_icon.png">&nbsp;收回
          </button>
        <% }else{ %>
          <button value="推薦" class="n" name="<%= timelinesList[i].id %>" id="TimelineNice">
            <img src="/images/img_forum/good_icon.png">&nbsp;推薦
          </button>
        <% } %>
      </div>
      <% if((typeof timelinesList[i].owner!="undefined" && timelinesList[i].owner.id==traveler) || (typeof timelinesList[i].owner=="undefined" && timelinesList[i].author==id && traveler==id)){ %>
        <div class="btn-group" style="float:none;">
           <button type="button" class="n" data-toggle="dropdown">
            <img src="/images/img_timeline/all.png" height="20px" width="20px">&nbsp;每個人都看得到
           </button>
           <ul class="dropdown-menu" role="menu">
              <li><a class="auth_set_all" name="<%= timelinesList[i].id %>"><img src="/images/img_timeline/all.png" height="20px">&nbsp;每個人都看得到</a></li>
              <li><a class="auth_set_friend" name="<%= timelinesList[i].id %>"><img src="/images/img_timeline/friend.png" height="20px" width="20px">&nbsp;只有好友看得到</a></li>
              <li><a class="auth_set_self" name="<%= timelinesList[i].id %>"><img src="/images/img_timeline/self.png" height="20px">&nbsp;只有自己看得到</a></li>
           </ul>
        </div>
      <% } %>
      <div class="btn-group" style="float:none;">
         <button type="button" class="n" data-toggle="dropdown">
          <span class="glyphicon glyphicon-menu-down" style="color:black;top:4px;" aria-hidden="true"></span>&nbsp;其他
         </button>                  
         <ul class="dropdown-menu" role="menu">
            <!--我去別人牆上發文，或是我在我自己牆上發文-->
            <% if((typeof timelinesList[i].owner!="undefined" && timelinesList[i].owner.id==traveler) || (typeof timelinesList[i].owner=="undefined" && timelinesList[i].author==id && traveler==id)){ %>
              <li><a class="event_edit" name="<%= timelinesList[i].id %>">編輯</a></li>
              <li><a class="event_del" name="<%= timelinesList[i].id %>">刪除</a></li>
            <!--別人來我牆上發文-->
            <% }else if( typeof timelinesList[i].owner!="undefined" && timelinesList[i].author==id ){ %>
              <li><a class="event_del" name="<%= timelinesList[i].id %>">刪除</a></li>
              <% if(JSON.stringify(timelinesList[i].report).indexOf('{"reporter":'+traveler+'}') > 0){ %>
                <li id="cancelReport_event" name="<%=timelinesList[i].id%>"><a class="cancelReport_event" name="<%=timelinesList[i].id%>">收回檢舉</a></li>
              <% }else{ %>
                <li id="report_event" name="<%=timelinesList[i].id%>"><a class="report_event" name="<%=timelinesList[i].id%>">檢舉</a></li>
              <% } %>
            <!--路人-->
            <% }else{ %>
              <% if(JSON.stringify(timelinesList[i].report).indexOf('{"reporter":'+traveler+'}') > 0){ %>
                <li id="cancelReport_event" name="<%=timelinesList[i].id%>"><a class="cancelReport_event" name="<%=timelinesList[i].id%>">收回檢舉</a></li>
              <% }else{ %>
                <li id="report_event" name="<%=timelinesList[i].id%>"><a class="report_event" name="<%=timelinesList[i].id%>">檢舉</a></li>
              <% } %>
            <% } %>
         </ul>
      </div>
   </div>
   <% } %>
   <div class="row-fluid" id="niceCount<%= timelinesList[i].id %>">有 <%= timelinesList[i].nicer.length %> 人推薦</div>

   <!--預設文章留言-->
   <div class="row-fluid default_event_commentlist" id="default_event_commentlist<%= timelinesList[i].id %>">
    <% for(var j=0; j<Math.min(timelinesList[i].response.length, 3); j++) {
      timelinesList[i].response[j].comment_image // 預先處理圖片
        = timelinesList[i].response[j].comment_image
        .replace(/dummy href=/g, "a href=")
        .replace(/\/dummy/g, "\/a");
      timeDiff = (new Date()-new Date(timelinesList[i].response[j].updatedTime).getTime())/1000; // 計算幾天前
      if(timeDiff > 86400){ago=Math.round(timeDiff/86400)+" 天前";
      }else if(timeDiff > 3600){ago=Math.round(timeDiff/3600)+" 小時前";
      }else if(timeDiff > 60){ago=Math.round(timeDiff/60)+" 分鐘前";
      }else{ago="剛剛";}%>
      <div id="container_timeline_res container-fluid" style="/*overflow:hidden;*/">
         <div id="sidebar_timeline_res">
          <img src="<%= timelinesList[i].response[j].img %>" height="50" width="50">
         </div>
         <div id="content_timeline_res">
            <!--留言內容-->
            <div class="event_text_r"><a class="name" href="?<%= timelinesList[i].response[j].author%>"><%= timelinesList[i].response[j].alias%></a> <%- timelinesList[i].response[j].comment.replace(/\bhttps:\/\/www\.youtube\.com\/watch\?v\=+(\w*)+\b/g, '<iframe width="560" height="315" src="https://www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe>') %></div>
            <% if(timelinesList[i].response[j].comment_image == ""){ %>
             <div class="row-fluid event_img" style="display:none;"></div>
            <% }else{ %>
             <div class="row-fluid event_img" style="display:block;"><%- timelinesList[i].response[j].comment_image %></div>
            <% } %>
            <!--留言編輯-->
            <% if(traveler != "guest"){ %>
            <div class="container-fluid container_r_edit" id="container_r_edit<%= timelinesList[i].response[j].id %>">
              <% if(timelinesList[i].response[j].comment_image == ""){ %>
                <div class="row-fluid" id="div_r_edit_content<%= timelinesList[i].response[j].id %>" contenteditable="true" style=""><%= timelinesList[i].response[j].comment %></div>
                <div class="row-fluid div_r_edit_img" id="div_r_edit_img<%= timelinesList[i].response[j].id %>" style="display:block;"></div>
              <% }else{ %>
                <div class="row-fluid" id="div_r_edit_content<%= timelinesList[i].response[j].id %>" contenteditable="true" style="border-bottom-left-radius: 0px;border-bottom-right-radius: 0px;"><%= timelinesList[i].response[j].comment %></div>
                <div class="row-fluid div_r_edit_img" id="div_r_edit_img<%= timelinesList[i].response[j].id %>" style="display:block;"><%- timelinesList[i].response[j].comment_image %></div>
              <% } %>
              <button value="編輯完成" id="editRSend" class="b" name="<%= timelinesList[i].response[j].id %>">
                <img src="/images/img_forum/check_icon.png">編輯完成
              </button>
              <button value="插入圖片" id="editRImage" class="b" name="<%= timelinesList[i].response[j].id %>">
                <img src="/images/img_forum/images_icon.png">插入圖片
              </button>
              <button value="取消編輯" id="editRCancel" class="b" name="<%= timelinesList[i].response[j].id %>">
                <span class="glyphicon glyphicon-remove" style="color:black;top:4px;" aria-hidden="true"></span>取消編輯
              </button>                      
            </div>
            <% } %>
            <!--留言時間、推薦、設定-->
            <div class="row-fluid event_option btn-group">
               <div style="min-height:30px;padding-top:10px;padding-right:10px;float:left;"><a target="_blank" title="<%- new Date(timelinesList[i].updatedTime).toISOString().replace(/T/, ' ').replace(/\..+/, '') %>"><%- ago%></a></div>
               <% if(traveler != "guest"){ %>
               <div class="btn-group" id="RniceArticle<%= timelinesList[i].response[j].id %>" style="float:none;">
                <% if( JSON.stringify(timelinesList[i].response[j].rnicer).indexOf('{"id":'+traveler+'}') > 0){ %>
                  <button class="n" name="<%= timelinesList[i].response[j].id %>" id="TimelineResponseCancelNice"><img style="width:24px; height:24px;" src="/images/img_forum/good2_icon.png"></button>
                <% }else{ %>
                  <button class="n" name="<%= timelinesList[i].response[j].id %>" id="TimelineResponseNice"><img src="/images/img_forum/good_icon.png"></button>
                <% } %>
               </div>
               <div class="btn-group" style="float:none;">
                  <button type="button" class="n" data-toggle="dropdown"><span class="glyphicon glyphicon-menu-down" style="color:black;top:4px;" aria-hidden="true"></span></button>                          
                  <ul class="dropdown-menu" role="menu">
                    <!--我去別人牆上發文，或是我在我自己牆上發文-->
                    <% if(timelinesList[i].response[j].author==traveler){ %>
                      <li><a class="comment_edit" name="<%= timelinesList[i].response[j].id %>">編輯</a></li>
                      <li><a class="comment_del" name="<%= timelinesList[i].response[j].id %>">刪除</a></li>
                    <!--別人來我牆上發文-->
                    <% }else if( traveler==id ){ %>
                      <li><a class="comment_del" name="<%= timelinesList[i].response[j].id %>">刪除</a></li>
                      <% if(JSON.stringify(timelinesList[i].response[j].rreporter).indexOf('{"reporter":'+traveler+'}') > 0){ %>
                        <li id="cancelReport_comment" name="<%= timelinesList[i].response[j].id %>"><a class="cancelReport_comment" name="<%= timelinesList[i].response[j].id %>">收回檢舉</a></li>
                      <% }else{ %>
                        <li><a class="report_comment" name="<%= timelinesList[i].response[j].id %>">檢舉</a></li>
                      <% } %>
                    <!--路人-->
                    <% }else{ %>
                      <% if(JSON.stringify(timelinesList[i].response[j].rreporter).indexOf('{"reporter":'+traveler+'}') > 0){ %>
                        <li id="cancelReport_comment" name="<%= timelinesList[i].response[j].id %>"><a class="cancelReport_comment" name="<%= timelinesList[i].response[j].id %>">收回檢舉</a></li>
                      <% }else{ %>
                        <li><a class="report_comment" name="<%= timelinesList[i].response[j].id %>">檢舉</a></li>
                      <% } %>
                    <% } %>
                  </ul>
               </div>
               <% } %>
               <div class="btn-group" style="float:none;min-height:30px;padding-top:10px;padding-right:10px;" id="RniceCount<%= timelinesList[i].response[j].id %>">有 <%= timelinesList[i].response[j].rnicer.length %> 人推薦</div>
            </div>
         </div>
      </div>
    <% } %>
   </div>

   <!--展開文章留言-->
   <div class="row-fluid event_commentlist" id="event_commentlist<%= timelinesList[i].id %>">
    <% for(var j=3; j<timelinesList[i].response.length; j++) {
      timelinesList[i].response[j].comment_image // 預先處理圖片
        = timelinesList[i].response[j].comment_image
        .replace(/dummy href=/g, "a href=")
        .replace(/\/dummy/g, "\/a");
      timeDiff = (new Date()-new Date(timelinesList[i].response[j].updatedTime).getTime())/1000; // 計算幾天前
      if(timeDiff > 86400){ago=Math.round(timeDiff/86400)+" 天前";
      }else if(timeDiff > 3600){ago=Math.round(timeDiff/3600)+" 小時前";
      }else if(timeDiff > 60){ago=Math.round(timeDiff/60)+" 分鐘前";
      }else{ago="剛剛";}%>
      <div id="container_timeline_res container-fluid" style="/*overflow:hidden;*/">
         <div id="sidebar_timeline_res">
          <img src="<%= timelinesList[i].response[j].img %>" height="50" width="50">
         </div>
         <div id="content_timeline_res">
            <!--留言內容-->
            <div class="event_text_r"><a class="name" href="?<%= timelinesList[i].response[j].author%>"><%= timelinesList[i].response[j].alias%></a> <%= timelinesList[i].response[j].comment %></div>
            <div class="row-fluid event_img" style="display:none;"></div>
            <% if(timelinesList[i].response[j].comment_image == ""){ %>
             <div class="row-fluid event_img" style="display:none;"></div>
            <% }else{ %>
             <div class="row-fluid event_img" style="display:block;"><%- timelinesList[i].response[j].comment_image %></div>
            <% } %>
            <!--留言編輯-->
            <% if(traveler != "guest"){ %>
            <div class="container-fluid container_r_edit" id="container_r_edit<%= timelinesList[i].response[j].id %>">
              <% if(timelinesList[i].response[j].comment_image == ""){ %>
                <div class="row-fluid" id="div_r_edit_content<%= timelinesList[i].response[j].id %>" contenteditable="true" style=""><%= timelinesList[i].response[j].comment %></div>
                <div class="row-fluid div_r_edit_img" id="div_r_edit_img<%= timelinesList[i].response[j].id %>" style="display:block;"></div>
              <% }else{ %>
                <div class="row-fluid" id="div_r_edit_content<%= timelinesList[i].response[j].id %>" contenteditable="true" style="border-bottom-left-radius: 0px;border-bottom-right-radius: 0px;"><%= timelinesList[i].response[j].comment %></div>
                <div class="row-fluid div_r_edit_img" id="div_r_edit_img<%= timelinesList[i].response[j].id %>" style="display:block;"><%- timelinesList[i].response[j].comment_image %></div>
              <% } %>
              <button value="編輯完成" id="editRSend" class="b" name="<%= timelinesList[i].response[j].id %>">
                <img src="/images/img_forum/check_icon.png">編輯完成
              </button>
              <button value="插入圖片" id="editRImage" class="b" name="<%= timelinesList[i].response[j].id %>">
                <img src="/images/img_forum/images_icon.png">插入圖片
              </button>
              <button value="取消編輯" id="editRCancel" class="b" name="<%= timelinesList[i].response[j].id %>">
                <span class="glyphicon glyphicon-remove" style="color:black;top:4px;" aria-hidden="true"></span>取消編輯
              </button>                      
            </div>
            <% } %>
            <!--留言時間、推薦、設定-->
            <div class="row-fluid event_option btn-group">
               <div style="min-height:30px;padding-top:10px;padding-right:10px;float:left;"><a target="_blank" title="<%- new Date(timelinesList[i].updatedTime).toISOString().replace(/T/, ' ').replace(/\..+/, '') %>"><%- ago%></a></div>
               <% if(traveler != "guest"){ %>
               <div class="btn-group" id="RniceArticle<%= timelinesList[i].response[j].id %>" style="float:none;">
                <% if( JSON.stringify(timelinesList[i].response[j].rnicer).indexOf('{"id":'+traveler+'}') > 0){ %>
                  <button class="n" name="<%= timelinesList[i].response[j].id %>" id="TimelineResponseCancelNice"><img style="width:24px; height:24px;" src="/images/img_forum/good2_icon.png"></button>
                <% }else{ %>
                  <button class="n" name="<%= timelinesList[i].response[j].id %>" id="TimelineResponseNice"><img src="/images/img_forum/good_icon.png"></button>
                <% } %>
               </div>
               <div class="btn-group" style="float:none;">
                  <button type="button" class="n" data-toggle="dropdown"><span class="glyphicon glyphicon-menu-down" style="color:black;top:4px;" aria-hidden="true"></span></button>                          
                  <ul class="dropdown-menu" role="menu">
                    <!--我去別人牆上發文，或是我在我自己牆上發文-->
                    <% if(timelinesList[i].response[j].author==traveler){ %>
                      <li><a class="comment_edit" name="<%= timelinesList[i].response[j].id %>">編輯</a></li>
                      <li><a class="comment_del" name="<%= timelinesList[i].response[j].id %>">刪除</a></li>
                    <!--別人來我牆上發文-->
                    <% }else if( traveler==id ){ %>
                      <li><a class="comment_del" name="<%= timelinesList[i].response[j].id %>">刪除</a></li>
                      <% if(JSON.stringify(timelinesList[i].response[j].rreporter).indexOf('{"reporter":'+traveler+'}') > 0){ %>
                        <li id="cancelReport_comment" name="<%= timelinesList[i].response[j].id %>"><a class="cancelReport_comment" name="<%= timelinesList[i].response[j].id %>">收回檢舉</a></li>
                      <% }else{ %>
                        <li><a class="report_comment" name="<%= timelinesList[i].response[j].id %>">檢舉</a></li>
                      <% } %>
                    <!--路人-->
                    <% }else{ %>
                      <% if(JSON.stringify(timelinesList[i].response[j].rreporter).indexOf('{"reporter":'+traveler+'}') > 0){ %>
                        <li id="cancelReport_comment" name="<%= timelinesList[i].response[j].id %>"><a class="cancelReport_comment" name="<%= timelinesList[i].response[j].id %>">收回檢舉</a></li>
                      <% }else{ %>
                        <li><a class="report_comment" name="<%= timelinesList[i].response[j].id %>">檢舉</a></li>
                      <% } %>
                    <% } %>
                  </ul>
               </div>
               <% } %>
               <div class="btn-group" style="float:none;min-height:30px;padding-top:10px;padding-right:10px;" id="RniceCount<%= timelinesList[i].response[j].id %>">有 <%= timelinesList[i].response[j].rnicer.length %> 人推薦</div>
            </div>
         </div>
      </div>
    <% } %>
   </div>

   <!--展開按鈕-->
   <% if(timelinesList[i].response.length < 4){ %>
     <div class="row-fluid readMore" id="readMore<%= timelinesList[i].id %>" style="margin: 15px; display: none;">
     <% }else{ %>
     <div class="row-fluid readMore" id="readMore<%= timelinesList[i].id %>" style="margin: 15px; display: block;">
      <% } %>
     <button class="n" id="expandComment" name="<%= timelinesList[i].id %>">
        <span class="glyphicon glyphicon-comment" style="color:black;top:4px;" aria-hidden="true"></span>&nbsp;展開留言
     </button>
   </div>
   
   <!--回覆區塊-->
   <% if(traveler != "guest"){ %>
   <div class="row-fluid event_comment">
      <table style="width:100%;">
         <tbody>
            <tr>
               <td style="width:50px;"><img src="<%= avatar %>" height="50" width="50"></td>
               <td style="padding:5px">
                  <div id="timeline_comment_content<%= timelinesList[i].id %>" contenteditable="true" class="edit_content"></div>
               </td>
            </tr>
            <tr>
               <td></td>
               <td>
                <button value="送出留言" name="<%= timelinesList[i].id %>" id="TimelineCommentSend" class="b"><img src="/images/img_forum/check_icon.png">送出留言</button>
                <button value="插入圖片" name="<%= timelinesList[i].id %>" id="TimelineImage" class="b"><img src="/images/img_forum/images_icon.png">插入圖片</button>
               </td>
            </tr>
         </tbody>
      </table>
      <div contenteditable="false" class="edit_content" id="timeline_comment_image<%= timelinesList[i].id %>">
         <div class="clear" id="comment_clear"></div>
      </div>
   </div>
   <% } %>
</div>
<% } %>